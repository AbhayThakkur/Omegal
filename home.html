<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Omegal.in</title>
    <style>
        .video-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px;
        }
        video {
            width: 400px;
            height: 300px;
            background: #333;
        }
        .controls {
            text-align: center;
            margin: 20px;
        }
        button {
            padding: 10px 20px;
            margin: 0 10px;
            font-size: 16px;
        }
        .connection-status {
            text-align: center;
            padding: 10px;
            margin: 10px;
            background-color: #ffebee;
            border: 1px solid #ffcdd2;
            border-radius: 4px;
        }
        #connectionError {
            color: #c62828;
            font-weight: bold;
        }
        .retry-button {
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .retry-button:hover {
            background-color: #1976D2;
        }
    </style>
</head>
<body>
    <div class="connection-status">
        <p id="connectionError">Not connected to video chat</p>
        <button id="retryConnection" class="retry-button">Retry Connection</button>
    </div>
    
    <div class="video-container">
        <video id="localVideo" autoplay playsinline></video>
        <video id="remoteVideo" autoplay playsinline></video>
    </div>

    <script>
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const retryButton = document.getElementById('retryConnection');
        const connectionError = document.getElementById('connectionError');
        let localStream;
        let peerConnection;
        let connectionAttempts = 0;
        const MAX_RETRIES = 3;

        const configuration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' },
                {
                    urls: 'turn:numb.viagenie.ca',
                    credential: 'muazkh',
                    username: 'webrtc@live.com'
                }
            ],
            iceCandidatePoolSize: 10
        };

        async function initConnection() {
            connectionError.textContent = 'Attempting to connect...';
            
            try {
                // Reset previous connection if exists
                if (peerConnection) {
                    peerConnection.close();
                }
                
                // Get local stream
                if (!localStream) {
                    localStream = await navigator.mediaDevices.getUserMedia({ 
                        video: true, 
                        audio: true 
                    });
                    localVideo.srcObject = localStream;
                }

                // Create new peer connection
                peerConnection = new RTCPeerConnection(configuration);
                
                // Add connection state monitoring
                peerConnection.onconnectionstatechange = handleConnectionStateChange;
                peerConnection.oniceconnectionstatechange = handleIceConnectionStateChange;
                
                // Add local tracks to connection
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });

                // Handle remote stream
                peerConnection.ontrack = event => {
                    remoteVideo.srcObject = event.streams[0];
                };

                // Create and set offer
                const offer = await peerConnection.createOffer({
                    offerToReceiveAudio: true,
                    offerToReceiveVideo: true
                });
                await peerConnection.setLocalDescription(offer);

                // Monitor ICE gathering state
                peerConnection.onicegatheringstatechange = () => {
                    if (peerConnection.iceGatheringState === 'complete') {
                        checkConnection();
                    }
                };

            } catch (error) {
                handleConnectionError(error);
            }
        }

        function handleConnectionStateChange() {
            switch(peerConnection.connectionState) {
                case 'connected':
                    connectionError.textContent = 'Connected successfully!';
                    connectionError.style.color = '#2E7D32';
                    break;
                case 'disconnected':
                case 'failed':
                    handleConnectionError('Connection lost or failed');
                    break;
                case 'closed':
                    connectionError.textContent = 'Connection closed';
                    break;
            }
        }

        function handleIceConnectionStateChange() {
            if (peerConnection.iceConnectionState === 'failed') {
                handleConnectionError('ICE connection failed');
            }
        }

        function handleConnectionError(error) {
            console.error('Connection error:', error);
            connectionError.textContent = 'Failed to connect. Please try again.';
            connectionError.style.color = '#c62828';
            connectionAttempts++;
            
            if (connectionAttempts >= MAX_RETRIES) {
                connectionError.textContent = 'Connection failed after multiple attempts. Please check your internet connection.';
                retryButton.disabled = true;
            }
        }

        function checkConnection() {
            if (!peerConnection || peerConnection.connectionState === 'failed') {
                handleConnectionError('Connection check failed');
            }
        }

        // Add retry button functionality
        retryButton.addEventListener('click', () => {
            if (connectionAttempts < MAX_RETRIES) {
                initConnection();
            }
        });

        // Initialize connection on page load
        window.addEventListener('load', initConnection);

        // Add window unload handler to clean up
        window.addEventListener('unload', () => {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            if (peerConnection) {
                peerConnection.close();
            }
        });
    </script>
</body>
</html>
